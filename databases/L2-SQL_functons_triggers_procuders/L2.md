## 1
### Utwórz baz ̨e danych aparaty. Utwórz u ̇zytkownika o nazwie b ̨ed  ̨acej twoim numerem albumu. Ustaw dla niego hasło, b ̨ed  ̨ace konkatenacj  ̨a twojego nazwiska i dwóch ostatnich cyfr numeru albumu. Nadaj utworzonemu u ̇zytkownikowi uprawnienia do selectowania, wstawiania i zmieniania danych w tabelach, jednak nie do tworzenia usuwania i modyfikowania tabel w bazie
```sql
CREATE DATABASE aparaty;

CREATE USER '279757'@'%' IDENTIFIED BY 'zajac57';

GRANT INSERT, SELECT, UPDATE ON aparaty.* TO '279757'@'%';
```

## 2
### Utwórz tabele o schematach:(a) Aparat (model: varchar(30), producent: int, matryca: int,obiektyw: int, waga: float, typ: enum(’kompaktowy’,’lustrzanka’, ’profesjonalny’, ’inny’))(b) Matryca (ID: int, przekatna: decimal(4,2), rozdzielczosc:decimal(3,1) typ: varchar(10))(c) Obiektyw (ID: int, model: varchar(30), minPrzeslona: float,maxPrzeslona: float)(d) Producent (ID: int, nazwa: varchar(50), kraj: varchar(20),adresKorespondencyjny: varchar(100))Zadbaj o to, by podkre ́slone atrybuty były kluczami głównymi, tam gdzie to mo ̇zliwezastosuj automatyczn  ̨a inkrementacj ̨e, w przypadku tabeli Matryca zacznij od IDo warto ́sci 100. W tabeli Aparat zadbaj by odpowiednie identyfikatory były klu-czami obcymi. Dodatkowo zadbaj, aby wprowadzane dane liczbowe nie miały war-to ́sci ujemnych a minPrzeslona < maxPrzeslona. W tabeli Producent nazwa producenta nie mo ̇ze by ́c pusta, a kraj oraz adres korespondencyjny dla siedziby gównej producenta powinny by ́c ustawione na nieznany w przypadku braku danych
```sql
CREATE TABLE Producent (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    nazwa VARCHAR(50) NOT NULL,
    kraj VARCHAR(20) DEFAULT 'nieznany',
    adresKorespondencyjny VARCHAR(100) DEFAULT 'nieznany'
);

CREATE TABLE Matryca (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    przekatna DECIMAL(4,2) CHECK (przekatna > 0),
    rozdzielczosc DECIMAL(3,1) CHECK (rozdzielczosc > 0),
    typ VARCHAR(10)
) AUTO_INCREMENT = 100;

CREATE TABLE Obiektyw (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    model VARCHAR(30),
    minPrzeslona FLOAT CHECK (minPrzeslona > 0),
    maxPrzeslona FLOAT CHECK (maxPrzeslona > 0),
    CONSTRAINT chk_przeslona CHECK (minPrzeslona < maxPrzeslona)
);


CREATE TABLE Aparat (
    model VARCHAR(30) PRIMARY KEY,
    producent INT,
    matryca INT,
    obiektyw INT,
    waga FLOAT CHECK (waga > 0),
    typ ENUM('kompaktowy', 'lustrzanka', 'profesjonalny', 'inny'),

    FOREIGN KEY (producent) REFERENCES Producent(ID),
    FOREIGN KEY (matryca) REFERENCES Matryca(ID),
    FOREIGN KEY (obiektyw) REFERENCES Obiektyw(ID)
);
```

## 3
### Połacz si ̨e z baza przy pomocy konta u ̇zytkownika utworzonego w zadaniu 1. Dodaj do ka ̇zdej z tabel po 15 rekordów (do tabeli Producenci koniecznie dodaj 5 pozycji z producentami, których kraj siedziby to Chiny). Dodatkowo dla ka ̇zdej z tabel spróbuj wprowadzi ́c rekordy naruszaj  ̨ace ograniczenia z zadania 2
```sql
-- login as me
sudo mariadb -u 279757 -p

INSERT INTO Producent (nazwa, kraj) VALUES 
('Canon', 'Japonia'), ('Nikon', 'Japonia'), ('Sony', 'Japonia'), 
('Xiaomi', 'Chiny'), ('DJI', 'Chiny'), ('Huawei', 'Chiny'), ('Insta360', 'Chiny'), ('Yongnuo', 'Chiny'),
('Leica', 'Niemcy'), ('Kodak', 'USA'), ('Fujifilm', 'Japonia'), ('Olympus', 'Japonia'),
('Panasonic', 'Japonia'), ('Pentax', 'Japonia'), ('Samsung', 'Korea');

INSERT INTO Matryca (przekatna, rozdzielczosc, typ) VALUES 
(35.9, 24.5, 'CMOS'), (35.9, 45.7, 'CMOS'), (23.5, 24.2, 'APS-C'), (23.5, 20.9, 'APS-C'), (13.2, 10.1, '1-inch'),
(35.9, 24.5, 'CMOS'), (35.9, 45.7, 'CMOS'), (23.5, 24.2, 'APS-C'), (23.5, 20.9, 'APS-C'), (13.2, 10.1, '1-inch'),
(35.9, 24.5, 'CMOS'), (35.9, 45.7, 'CMOS'), (23.5, 24.2, 'APS-C'), (23.5, 20.9, 'APS-C'), (13.2, 10.1, '1-inch');

INSERT INTO Obiektyw (model, minPrzeslona, maxPrzeslona) VALUES
('Kit 18-55', 3.5, 5.6), ('Prime 50mm', 1.8, 22), ('Zoom 70-200', 2.8, 22), ('Macro 100mm', 2.8, 32), ('Wide 10-20', 4.5, 22),
('Kit 18-55 v2', 3.5, 5.6), ('Prime 85mm', 1.8, 22), ('Zoom 24-70', 2.8, 22), ('Macro 60mm', 2.8, 32), ('Wide 12-24', 4.0, 22),
('Kit 15-45', 3.5, 5.6), ('Prime 35mm', 1.4, 16), ('Zoom 100-400', 4.5, 32), ('Macro 90mm', 2.8, 32), ('Fisheye', 2.8, 22);

INSERT INTO Aparat (model, producent, matryca, obiektyw, waga, typ) VALUES
('EOS R5', 1, 100, 1, 738, 'profesjonalny'),
('D850', 2, 101, 2, 1005, 'lustrzanka'),
('Alpha A7', 3, 102, 3, 650, 'kompaktowy'),
('Mi Cam', 4, 103, 4, 200, 'kompaktowy'),
('Mavic Lens', 5, 104, 5, 150, 'inny'),
('P40 Cam', 6, 105, 6, 180, 'inny'),
('One R', 7, 106, 7, 120, 'inny'),
('YN450', 8, 107, 8, 500, 'kompaktowy'),
('M10', 9, 108, 9, 660, 'profesjonalny'),
('PixPro', 10, 109, 10, 300, 'kompaktowy'),
('X-T4', 11, 110, 11, 607, 'lustrzanka'),
('OM-D', 12, 111, 12, 400, 'lustrzanka'),
('Lumix GH5', 13, 112, 13, 725, 'profesjonalny'),
('K-1', 14, 113, 14, 1010, 'lustrzanka'),
('NX1', 15, 114, 15, 550, 'kompaktowy');
```

## 4
### Napisz procedur ̨e, która na podstawie danych z tabel Matryca, Obiektyw oraz Producent wygeneruje 100 nowych modeli aparatów (o losowych lub sekwen- cyjnych nazwach) i uzupełni nimi tabel ̨e Aparat. Czy  ̇zaden z modeli si ̨e nie powtarza? Czy procedura mo ̇ze by ́c utworzona i wykonana przez u ̇zytkownika z zadania 1?
```sql
DELIMITER //
CREATE PROCEDURE GenerujAparaty()
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE rand_prod INT;
    DECLARE rand_matr INT;
    DECLARE rand_obiek INT;
    DECLARE new_model_name VARCHAR(30);

    WHILE i < 100 DO
        SELECT ID INTO rand_prod FROM Producent ORDER BY RAND() LIMIT 1;
        SELECT ID INTO rand_matr FROM Matryca ORDER BY RAND() LIMIT 1;
        SELECT ID INTO rand_obiek FROM Obiektyw ORDER BY RAND() LIMIT 1;
        
        SET new_model_name = CONCAT('AutoModel_', i, '_', FLOOR(RAND()*1000));
        
        IF NOT EXISTS (SELECT 1 FROM Aparat WHERE model = new_model_name) THEN
            INSERT INTO Aparat (model, producent, matryca, obiektyw, waga, typ)
            VALUES (new_model_name, rand_prod, rand_matr, rand_obiek, 500.0, 'inny');
            SET i = i + 1;
        END IF;
    END WHILE;
END //
DELIMITER ;

-- Odpowiedź na pytanie: Procedura została utworzona przez roota, użytkownik z Zad. 1 NIE może 
```

## 5
### Napisz funkcj ̨e lub procedur ̨e, która dla podanego ID producenta, zwraca wyprodukowany przez niego model aparatu z najmniejsz  ̨a przek  ̨atn  ̨a matrycy
```sql
DELIMITER //
CREATE FUNCTION ModelZNajmniejszaMatryca(prod_id INT) RETURNS VARCHAR(30)
DETERMINISTIC
BEGIN
    DECLARE wynik VARCHAR(30);
    
    SELECT A.model INTO wynik
    FROM Aparat A
    JOIN Matryca M ON A.matryca = M.ID
    WHERE A.producent = prod_id
    ORDER BY M.przekatna ASC
    LIMIT 1;
    
    RETURN wynik;
END //
DELIMITER ;
```

## 6
### Napisz trigger, który pozwoli wstawi ́c do tabeli Aparat model wyprodukowanyprzez dowolnego producenta, a je ́sli takiego nie ma jeszcze w bazie danych, dodaje go do odpowiedniej tabeli
```sql
DELIMITER //
CREATE TRIGGER Before_Insert_Aparat
BEFORE INSERT ON Aparat
FOR EACH ROW
BEGIN
    DECLARE prod_exists INT;
    
    SELECT COUNT(*) INTO prod_exists FROM Producent WHERE ID = NEW.producent;
    
    IF prod_exists = 0 THEN
        INSERT INTO Producent (ID, nazwa, kraj) 
        VALUES (NEW.producent, CONCAT('NowyProducent_', NEW.producent), 'Nieznany');
    END IF;
END //
DELIMITER ;
```

## 7 
### Napisz funkcj ̨e, która dla podanego ID matrycy, zwraca liczb ̨e modeli aparatów z dan  ̨a matryc  ̨a
```sql
DELIMITER //
CREATE FUNCTION LiczbaModeliZMatryca(matr_id INT) RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE licznik INT;
    SELECT COUNT(*) INTO licznik FROM Aparat WHERE matryca = matr_id;
    RETURN licznik;
END //
DELIMITER ;
```

## 8
### Napisz trigger usuwaj  ̨acy z tabeli Matryca matryc ̨e, dla której usuni ̨ety został ostatni aparat j  ̨a wykorzystuj  ̨ac
```sql
DELIMITER //
CREATE TRIGGER After_Delete_Aparat
AFTER DELETE ON Aparat
FOR EACH ROW
BEGIN
    DECLARE cnt INT;
    SELECT COUNT(*) INTO cnt FROM Aparat WHERE matryca = OLD.matryca;
    
    IF cnt = 0 THEN
        DELETE FROM Matryca WHERE ID = OLD.matryca;
    END IF;
END //
DELIMITER ;
```

## 9
### Stwórz widok zawieraj  ̨acy model aparatu, jego wag ̨e, nazw ̨e jego producenta, prze- k  ̨atn  ̨a i rozdzielczo ́s ́c jego matrycy, minimaln  ̨a oraz maksymymaln  ̨a warto ́s ́c prze- słony dla wszystkich aparatów typu lustrzanka wyprodukowanych przez produ- centów maj  ̨acych siedzib ̨e poza Chinami. Czy zadanie mo ̇ze wykona ́c u ̇zytkownik z zadania 1?
```sql
CREATE VIEW Widok_Lustrzanki_NonChina AS
SELECT 
    A.model,
    A.waga,
    P.nazwa AS producent_nazwa,
    M.przekatna,
    M.rozdzielczosc,
    O.minPrzeslona,
    O.maxPrzeslona
FROM Aparat A
JOIN Producent P ON A.producent = P.ID
JOIN Matryca M ON A.matryca = M.ID
JOIN Obiektyw O ON A.obiektyw = O.ID
WHERE A.typ = 'lustrzanka' AND P.kraj <> 'Chiny';

-- Czy użytkownik z Zad. 1 może to wykonać? NIE
```

## 10
### Stwórz widok zawieraj  ̨acy nazw ̨e i kraj producenta oraz model, dla wszystkich aparatów. Nast ̨epnie usu  ́n z tabeli Aparat wszystkie modele producentów z Chin. Czy co ́s zmieniło si ̨e w widoku
```sql
CREATE VIEW Widok_Wszystkie AS
SELECT P.nazwa, P.kraj, A.model
FROM Aparat A
JOIN Producent P ON A.producent = P.ID;

-- Instrukcja usuwania:
DELETE FROM Aparat WHERE producent IN (SELECT ID FROM Producent WHERE kraj = 'Chiny');

-- Pytanie: Czy coś zmieniło się w widoku?
-- Odp: Tak, rekordy znikną automatycznie z widoku, ponieważ widok to "wirtualna tabela"
-- odzwierciedlająca aktualny stan danych.
```

## 11
### 
```sql
ALTER TABLE Producent ADD COLUMN liczbaModeli INT DEFAULT 0 NOT NULL;

UPDATE Producent P
SET liczbaModeli = (SELECT COUNT(*) FROM Aparat A WHERE A.producent = P.ID);

DELIMITER //

CREATE TRIGGER UpdateCount_AfterInsert AFTER INSERT ON Aparat
FOR EACH ROW
BEGIN
   UPDATE Producent SET liczbaModeli = liczbaModeli + 1 WHERE ID = NEW.producent;
END //

CREATE TRIGGER UpdateCount_AfterDelete AFTER DELETE ON Aparat
FOR EACH ROW
BEGIN
   UPDATE Producent SET liczbaModeli = liczbaModeli - 1 WHERE ID = OLD.producent;
END //

CREATE TRIGGER UpdateCount_AfterUpdate AFTER UPDATE ON Aparat
FOR EACH ROW
BEGIN
   IF OLD.producent <> NEW.producent THEN
       UPDATE Producent SET liczbaModeli = liczbaModeli - 1 WHERE ID = OLD.producent;
       UPDATE Producent SET liczbaModeli = liczbaModeli + 1 WHERE ID = NEW.producent;
   END IF;
END //

DELIMITER ;

-- Trigger stworzony przez roota DZIAŁA podczas operacji mojego użytkownika,
-- ponieważ triggery wykonują się w kontekście uprawnień definiującego (DEFINER), chyba że określono inaczej.
-- Mój użytkownik NIE może utworzyć triggera (brak uprawnienia TRIGGER).
```